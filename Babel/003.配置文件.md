## é…ç½®æ–‡ä»¶ç±»å‹

Babel æœ‰ä¸¤ç§å¹¶è¡Œçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚
- é¡¹ç›®èŒƒå›´çš„é…ç½®
  - babel.config.* æ–‡ä»¶ï¼Œå…·æœ‰ä»¥ä¸‹æ‰©å±•åï¼š .jsonã€.jsã€.cjsã€.mjsã€.ctsã€‚

- æ–‡ä»¶ç›¸å…³é…ç½®
  - .babelrc.* æ–‡ä»¶ï¼Œå…·æœ‰ä»¥ä¸‹æ‰©å±•åï¼š .jsonã€.jsã€.cjsã€.mjsã€.ctsã€‚
  - .babelrc æ–‡ä»¶ï¼Œæ²¡æœ‰æ‰©å±•åã€‚
  - package.json æ–‡ä»¶ï¼Œå¸¦æœ‰ "babel" å¯†é’¥ã€‚

## é¡¹ç›®èŒƒå›´çš„é…ç½®

Babel 7.x ä¸­çš„æ–°åŠŸèƒ½ï¼ŒBabel æœ‰ä¸€ä¸ª ["root"](https://babel.nodejs.cn/docs/options#root) ç›®å½•çš„æ¦‚å¿µï¼Œé»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•ã€‚ å¯¹äºé¡¹ç›®èŒƒå›´çš„é…ç½®ï¼ŒBabel ä¼šè‡ªåŠ¨åœ¨è¿™ä¸ªæ ¹ç›®å½•ä¸­æœç´¢ä¸€ä¸ª babel.config.json æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ [æ”¯æŒçš„æ‰©å±•](https://babel.nodejs.cn/docs/config-files#supported-file-extensions) çš„ç­‰æ•ˆæ–‡ä»¶ã€‚ æˆ–è€…ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨æ˜¾å¼ ["configFile"](https://babel.nodejs.cn/docs/options#configfile) å€¼æ¥è¦†ç›–é»˜è®¤é…ç½®æ–‡ä»¶æœç´¢è¡Œä¸ºã€‚

å› ä¸ºé¡¹ç›®èŒƒå›´çš„é…ç½®æ–‡ä»¶ä¸é…ç½®æ–‡ä»¶çš„ç‰©ç†ä½ç½®æ˜¯åˆ†å¼€çš„ï¼Œæ‰€ä»¥å®ƒä»¬éå¸¸é€‚åˆå¿…é¡»å¹¿æ³›åº”ç”¨çš„é…ç½®ï¼Œç”šè‡³å…è®¸æ’ä»¶å’Œé¢„è®¾è½»æ¾åº”ç”¨äº node_modules æˆ–ç¬¦å·é“¾æ¥åŒ…ä¸­çš„æ–‡ä»¶ï¼Œè¿™åœ¨ä¼ ç»Ÿä¸Šæ˜¯ç›¸å½“ç—›è‹¦çš„åœ¨ Babel 6.x ä¸­é…ç½®ã€‚

è¿™ä¸ªé¡¹ç›®èŒƒå›´é…ç½®çš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå› ä¸ºå®ƒä¾èµ–äºå·¥ä½œç›®å½•ï¼Œå¦‚æœå·¥ä½œç›®å½•ä¸æ˜¯å¤§ä»“æ ¹ç›®å½•ï¼Œé‚£ä¹ˆåœ¨å¤§ä»“ä¸­ä½¿ç”¨ä¼šæ›´åŠ ç—›è‹¦ã€‚ æœ‰å…³å¦‚ä½•åœ¨è¯¥ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹ï¼Œè¯·å‚é˜… [å¤§ä»“](https://babel.nodejs.cn/docs/config-files#monorepos) æ–‡æ¡£ã€‚

ä¹Ÿå¯ä»¥é€šè¿‡å°† ["configFile"](https://babel.nodejs.cn/docs/options#configfile) è®¾ç½®ä¸º false æ¥ç¦ç”¨é¡¹ç›®èŒƒå›´çš„é…ç½®ã€‚

## æ–‡ä»¶ç›¸å…³é…ç½®

Babel åŠ è½½ .babelrc.json æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ [æ”¯æŒçš„æ‰©å±•](https://babel.nodejs.cn/docs/config-files#supported-file-extensions) çš„ç­‰æ•ˆæ–‡ä»¶ï¼Œé€šè¿‡æœç´¢ä»æ­£åœ¨ç¼–è¯‘çš„ ["filename"](https://babel.nodejs.cn/docs/options#filename) å¼€å§‹çš„ç›®å½•ç»“æ„ï¼ˆå—ä»¥ä¸‹è­¦å‘Šé™åˆ¶ï¼‰ã€‚ è¿™å¯èƒ½å¾ˆå¼ºå¤§ï¼Œå› ä¸ºå®ƒå…è®¸ä½ ä¸ºåŒ…çš„å­éƒ¨åˆ†åˆ›å»ºç‹¬ç«‹çš„é…ç½®ã€‚ æ–‡ä»¶ç›¸å…³é…ç½®ä¹Ÿæ˜¯é¡¹ç›®èŒƒå›´é…ç½®å€¼ä¹‹ä¸Šçš„ [merged](https://babel.nodejs.cn/docs/options#merging)ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯èƒ½å¯¹ç‰¹å®šçš„è¦†ç›–æœ‰ç”¨ï¼Œå°½ç®¡è¿™ä¹Ÿå¯ä»¥é€šè¿‡ ["overrides"](https://babel.nodejs.cn/docs/options#overrides) æ¥å®Œæˆã€‚

ä½¿ç”¨æ–‡ä»¶ç›¸å¯¹é…ç½®æ—¶éœ€è¦è€ƒè™‘ä¸€äº›è¾¹ç¼˜æƒ…å†µï¼š

ä¸€æ—¦æ‰¾åˆ°åŒ…å« package.json çš„ç›®å½•ï¼Œæœç´¢å°†åœæ­¢ï¼Œå› æ­¤ç›¸å¯¹é…ç½®ä»…é€‚ç”¨äºå•ä¸ªåŒ…ä¸­ã€‚
æ­£åœ¨ç¼–è¯‘çš„ ["filename"](https://babel.nodejs.cn/docs/options#filename) å¿…é¡»åœ¨ ["babelrcRoots"](https://babel.nodejs.cn/docs/options#babelrcroots) åŒ…å†…ï¼Œå¦åˆ™å°†å®Œå…¨è·³è¿‡æœç´¢ã€‚
è¿™äº›è­¦å‘Šæ„å‘³ç€ï¼š

.babelrc.json æ–‡ä»¶åªé€‚ç”¨äºè‡ªå·±åŒ…å†…çš„æ–‡ä»¶
ä¸å±äº Babel çš„ 'root' çš„åŒ…ä¸­çš„ .babelrc.json æ–‡ä»¶å°†è¢«å¿½ç•¥ï¼Œé™¤éä½ é€‰æ‹©ä½¿ç”¨ ["babelrcRoots"](https://babel.nodejs.cn/docs/options#babelrcroots)ã€‚
æœ‰å…³å¦‚ä½•é…ç½®å…·æœ‰è®¸å¤šåŒ…çš„å¤§ä»“çš„æ›´å¤šè®¨è®ºï¼Œè¯·å‚é˜… [å¤§ä»“](https://babel.nodejs.cn/docs/config-files#monorepos) æ–‡æ¡£ã€‚ ä¹Ÿå¯ä»¥é€šè¿‡å°† ["babelrc"](https://babel.nodejs.cn/docs/options#babelrc) è®¾ç½®ä¸º false æ¥ç¦ç”¨æ–‡ä»¶ç›¸å…³é…ç½®ã€‚

### 6.x ä¸ 7.x .babelrc åŠ è½½

æ¥è‡ª Babel 6.x çš„ç”¨æˆ·å¯èƒ½ä¼šé‡åˆ°è¿™ä¸¤ç§æç«¯æƒ…å†µï¼Œè¿™åœ¨ Babel 7.x ä¸­æ˜¯æ–°çš„ã€‚ æ·»åŠ äº†è¿™ä¸¤ä¸ªé™åˆ¶ä»¥è§£å†³ Babel 6.x ä¸­çš„å¸¸è§è¶³æªé—®é¢˜ï¼š

- .babelrc æ–‡ä»¶åº”ç”¨äº node_modules ä¾èµ–ï¼Œé€šå¸¸æ˜¯å‡ºä¹æ„æ–™çš„ã€‚
- å½“äººä»¬æœŸæœ› .babelrc æ–‡ä»¶è¡¨ç°å¾—åƒæ­£å¸¸ä¾èµ–æ—¶ï¼Œ.babelrc æ–‡ä»¶æœªèƒ½åº”ç”¨äºç¬¦å·é“¾æ¥çš„ node_modulesã€‚
- ä¼šæ£€æµ‹åˆ° node_modules ä¾èµ–ä¸­çš„ .babelrc æ–‡ä»¶ï¼Œå³ä½¿å®ƒä»¬ä¸­çš„æ’ä»¶å’Œé¢„è®¾é€šå¸¸æ²¡æœ‰å®‰è£…ï¼Œç”šè‡³å¯èƒ½åœ¨ Babel ç¼–è¯‘æ–‡ä»¶çš„ç‰ˆæœ¬ä¸­æ— æ•ˆã€‚
- 
è¿™äº›æƒ…å†µä¸»è¦ä¼šç»™å…·æœ‰å¤§ä»“ç»“æ„çš„ç”¨æˆ·å¸¦æ¥é—®é¢˜ï¼Œå› ä¸ºå¦‚æœä½ æœ‰

```
.babelrc
packages/
  mod1/
    package.json
    src/index.js
  mod2/
    package.json
    src/index.js
```

é…ç½®ç°åœ¨å°†è¢«å®Œå…¨å¿½ç•¥ï¼Œå› ä¸ºå®ƒè·¨è¶Šäº†åŒ…è¾¹ç•Œã€‚

ä¸€ç§æ›¿ä»£æ–¹æ³•æ˜¯åœ¨æ¯ä¸ªä½¿ç”¨ ["extends"](https://babel.nodejs.cn/docs/options#extends) çš„å­åŒ…ä¸­åˆ›å»ºä¸€ä¸ª .babelrc

```json
// .babelrc.json
{ "extends": "../../.babelrc" }
```

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½æœ‰ç‚¹é‡å¤ï¼Œå¹¶ä¸”æ ¹æ® Babel çš„ä½¿ç”¨æ–¹å¼ï¼Œå¯èƒ½éœ€è¦è®¾ç½® ["babelrcRoots"](https://babel.nodejs.cn/docs/options#babelrcroots)ã€‚

é‰´äºæ­¤ï¼Œå°† .babelrc é‡å‘½åä¸º [é¡¹ç›®èŒƒå›´ "babel.config.json"](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) å¯èƒ½æ›´å¯å–ã€‚ å¦‚ä¸Šé¢é¡¹ç›®èŒƒå›´éƒ¨åˆ†æ‰€è¿°ï¼Œè¿™å¯èƒ½éœ€è¦æ˜¾å¼è®¾ç½® ["configFile"](https://babel.nodejs.cn/docs/options#configfile) å› ä¸ºå¦‚æœå·¥ä½œç›®å½•ä¸æ­£ç¡®ï¼ŒBabel å°†æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ã€‚

## æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å

Babel å¯ä»¥ä½¿ç”¨ Node.js åŸç”Ÿæ”¯æŒçš„ä»»ä½•æ–‡ä»¶æ‰©å±•åè¿›è¡Œé…ç½®ï¼Œå¦‚ [é…ç½®æ–‡ä»¶ç±»å‹](https://babel.nodejs.cn/docs/config-files#configuration-file-types) éƒ¨åˆ†æ‰€è¿°ï¼š

- babel.config.json å’Œ .babelrc.json è¢«è§£æä¸º JSON5 å¹¶ä¸”åº”è¯¥åŒ…å«ä¸€ä¸ªåŒ¹é… Babel æ¥å—çš„ [é€‰é¡¹](https://babel.nodejs.cn/docs/options) æ ¼å¼çš„å¯¹è±¡ã€‚ è‡ª v7.7.0 ä»¥æ¥ï¼Œå®ƒä»¬ä¸€ç›´å—åˆ°æ”¯æŒã€‚

- æˆ‘ä»¬å»ºè®®å°½å¯èƒ½ä½¿ç”¨æ­¤æ–‡ä»¶ç±»å‹ï¼š å¦‚æœä½ æœ‰å¤æ‚çš„é…ç½®ï¼ˆåœ¨æ„å»ºæ—¶æ˜¯æœ‰æ¡ä»¶çš„æˆ–ä»¥å…¶ä»–æ–¹å¼è®¡ç®—çš„ï¼‰ï¼Œé‚£ä¹ˆ JS é…ç½®æ–‡ä»¶ä¼šå¾ˆæ–¹ä¾¿ã€‚ ä½†æ˜¯ï¼Œç¼ºç‚¹æ˜¯ JS é…ç½®çš„é™æ€å¯åˆ†ææ€§è¾ƒå·®ï¼Œå› æ­¤å¯¹å¯ç¼“å­˜æ€§ã€lintingã€IDE è‡ªåŠ¨è¡¥é½ç­‰æœ‰è´Ÿé¢å½±å“ã€‚ç”±äº babel.config.json å’Œ .babelrc.json æ˜¯é™æ€ JSON æ–‡ä»¶ï¼Œå®ƒå…è®¸å…¶ä»–ä½¿ç”¨ Babel çš„å·¥å…·ï¼ˆä¾‹å¦‚æ‰“åŒ…å™¨ï¼‰ç¼“å­˜ Babel å®‰å…¨çš„ç»“æœï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ„å»ºæ€§èƒ½èƒœåˆ©ã€‚

- babel.config.cjs å’Œ .babelrc.cjs å…è®¸ä½ ä½¿ç”¨ module.exports å°†ä½ çš„é…ç½®å®šä¹‰ä¸º CommonJSã€‚ è‡ª v7.7.0 ä»¥æ¥ï¼Œå®ƒä»¬ä¸€ç›´å—åˆ°æ”¯æŒã€‚

- babel.config.mjs å’Œ .babelrc.mjs ä½¿ç”¨åŸç”Ÿ ECMAScript æ¨¡å—ã€‚ å®ƒä»¬å— Node.js 13.2+ï¼ˆæˆ–é€šè¿‡ --experimental-modules æ ‡å¿—çš„æ—§ç‰ˆæœ¬ï¼‰æ”¯æŒã€‚ è¯·è®°ä½åŸç”Ÿ ECMAScript æ¨¡å—æ˜¯å¼‚æ­¥çš„ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ import() æ€»æ˜¯è¿”å›ä¸€ä¸ª promiseï¼ï¼‰ï¼š å› æ­¤ï¼Œ.mjs é…ç½®æ–‡ä»¶åœ¨åŒæ­¥è°ƒç”¨ Babel æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è‡ª v7.8.0 ä»¥æ¥ï¼Œå®ƒä»¬ä¸€ç›´å—åˆ°æ”¯æŒã€‚

- å½“ä½ çš„ package.json æ–‡ä»¶åŒ…å« "type": "module" é€‰é¡¹æ—¶ï¼Œbabel.config.js å’Œ .babelrc.js çš„è¡Œä¸ºç±»ä¼¼äº .mjs ç­‰æ•ˆé¡¹ï¼Œå¦åˆ™å®ƒä»¬ä¸ .cjs æ–‡ä»¶å®Œå…¨ç›¸åŒã€‚

- babel.config.cts å’Œ .babelrc.cts å…è®¸ä½ å°†é…ç½®å®šä¹‰ä¸º Typescript + CommonJSã€‚ ä½ å¿…é¡»å®‰è£… @babel/preset-typescriptï¼Œæˆ–è€…ä½¿ç”¨ ts-node è¿è¡Œ Babelã€‚

> NOTE <br>ğŸš§ æ­¤åŠŸèƒ½æ˜¯å®éªŒæ€§çš„ã€‚ å°šä¸èƒ½ä½¿ç”¨ babel.config.ts å’Œ babel.config.mts æ–‡ä»¶ï¼Œç­‰å¾… Node.js ESM åŠ è½½ç¨‹åº API çš„ç¨³å®šã€‚

JavaScript é…ç½®æ–‡ä»¶æ—¢å¯ä»¥å¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°å°†è¿”å›ç”Ÿæˆçš„é…ç½®ã€‚ å‡½æ•°è¿”å›é…ç½®è¢«èµ‹äºˆäº†ä¸€äº›ç‰¹æ®Šçš„æƒåŠ›ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥è®¿é—® Babel æœ¬èº«å…¬å¼€çš„ APIã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [é…ç½®å‡½æ•°æ¥å£](https://babel.nodejs.cn/docs/config-files#config-function-api)ã€‚

>NOTE <br>å‡ºäºå…¼å®¹æ€§åŸå› ï¼Œ.babelrc æ˜¯ .babelrc.json çš„åˆ«åã€‚


## å¤§ä»“

Monorepo ç»“æ„çš„å­˜å‚¨åº“é€šå¸¸åŒ…å«è®¸å¤šåŒ…ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ç»å¸¸é‡åˆ° [æ–‡ä»¶ç›¸å…³é…ç½®](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) å’Œé…ç½®æ–‡ä»¶åŠ è½½ä¸­æåˆ°çš„è­¦å‘Šã€‚ æœ¬èŠ‚æ—¨åœ¨å¸®åŠ©ç”¨æˆ·äº†è§£å¦‚ä½•å¤„ç†å¤§ä»“é…ç½®ã€‚

å¯¹äºå¤§ä»“è®¾ç½®ï¼Œè¦ç†è§£çš„æ ¸å¿ƒæ˜¯ Babel å°†ä½ çš„å·¥ä½œç›®å½•è§†ä¸ºå…¶é€»è¾‘ ["root"](https://babel.nodejs.cn/docs/options#root)ï¼Œå¦‚æœä½ æƒ³åœ¨ç‰¹å®šå­åŒ…ä¸­è¿è¡Œ Babel å·¥å…·è€Œä¸å°† Babel åº”ç”¨åˆ°æ•´ä¸ª repoï¼Œè¿™ä¼šå¯¼è‡´é—®é¢˜ã€‚

å¦å¤–ï¼Œå†³å®šä½ æ˜¯è¦ä½¿ç”¨ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) æ–‡ä»¶è¿˜æ˜¯åªä½¿ç”¨ä¸­å¤® [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ä¹Ÿå¾ˆé‡è¦ã€‚ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) æ–‡ä»¶ä¸éœ€è¦åƒåœ¨ Babel 6 ä¸­é‚£æ ·ç”¨äºç‰¹å®šäºå­æ–‡ä»¶å¤¹çš„é…ç½®ï¼Œå› æ­¤åœ¨ Babel 7 ä¸­é€šå¸¸ä¸éœ€è¦å®ƒä»¬ï¼Œæœ‰åˆ©äº [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration)ã€‚

æ ¹ babel.config.json æ–‡ä»¶
ä»»ä½•å¤§ä»“ç»“æ„çš„ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯åœ¨å­˜å‚¨åº“æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ã€‚ è¿™ç¡®ç«‹äº† Babel çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå³å­˜å‚¨åº“çš„åŸºæœ¬ç›®å½•ã€‚ å³ä½¿ä½ æƒ³ä½¿ç”¨ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) æ–‡ä»¶æ¥é…ç½®æ¯ä¸ªå•ç‹¬çš„åŒ…ï¼Œé‡è¦çš„æ˜¯è¦æœ‰ä¸€ä¸ªå­˜å‚¨åº“çº§åˆ«é€‰é¡¹çš„ä½ç½®ã€‚

ä½ é€šå¸¸å¯ä»¥å°†æ‰€æœ‰ repo é…ç½®æ”¾åœ¨æ ¹ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) ä¸­ã€‚ ä½¿ç”¨ ["overrides"](https://babel.nodejs.cn/docs/options#overrides)ï¼Œä½ å¯ä»¥è½»æ¾åœ°æŒ‡å®šä»…é€‚ç”¨äºå­˜å‚¨åº“çš„æŸäº›å­æ–‡ä»¶å¤¹çš„é…ç½®ï¼Œè¿™é€šå¸¸æ¯”åœ¨å­˜å‚¨åº“ä¸­åˆ›å»ºè®¸å¤š .babelrc.json æ–‡ä»¶æ›´å®¹æ˜“éµå¾ªã€‚

ä½ å¯èƒ½ä¼šé‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒBabel æœŸæœ›ä»è®¾ç½®ä¸º ["root"](https://babel.nodejs.cn/docs/options#root) çš„ç›®å½•ä¸­åŠ è½½ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ åˆ›å»º [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration)ï¼Œä½†åœ¨å•ä¸ªåŒ…ä¸­è¿è¡Œ Babelï¼Œä¾‹å¦‚

```sh
cd packages/some-package;
babel src -d dist
```

åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„ ["root"](https://babel.nodejs.cn/docs/options#root) Babel ä¸æ˜¯ä½ çš„å¤§ä»“æ ¹ï¼Œå®ƒæ— æ³•æ‰¾åˆ° [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ã€‚

å¦‚æœä½ çš„æ‰€æœ‰æ„å»ºè„šæœ¬éƒ½ç›¸å¯¹äºä½ çš„å­˜å‚¨åº“æ ¹ç›®å½•è¿è¡Œï¼Œé‚£ä¹ˆä¸€åˆ‡åº”è¯¥å·²ç»å·¥ä½œäº†ï¼Œä½†æ˜¯å¦‚æœä½ æ˜¯ä»ä¸€ä¸ªå­åŒ…ä¸­è¿è¡Œä½ çš„ Babel ç¼–è¯‘è¿‡ç¨‹ï¼Œä½ éœ€è¦å‘Šè¯‰ Babel åœ¨å“ªé‡Œå¯»æ‰¾é…ç½®ã€‚ æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†æ¨èçš„æ–¹æ³•æ˜¯ä½¿ç”¨ "upward" çš„ ["rootMode"](https://babel.nodejs.cn/docs/options#rootmode) é€‰é¡¹ï¼Œè¿™å°†ä½¿ Babel ä»å·¥ä½œç›®å½•å‘ä¸Šæœç´¢ä½ çš„ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä½ç½®ç”¨ä½œ ["root"](https://babel.nodejs.cn/docs/options#root) å€¼ã€‚

æµ‹è¯•ä½ çš„é…ç½®æ˜¯å¦è¢«æ£€æµ‹åˆ°çš„ä¸€ç§æœ‰ç”¨æ–¹æ³•æ˜¯ï¼Œå¦‚æœå®ƒæ˜¯ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) JavaScript æ–‡ä»¶ï¼Œåˆ™åœ¨å…¶ä¸­æ”¾ç½®ä¸€ä¸ª console.log() è°ƒç”¨ï¼š æ—¥å¿—å°†åœ¨ Babel ç¬¬ä¸€æ¬¡åŠ è½½å®ƒæ—¶æ‰§è¡Œã€‚

è®¾ç½®æ­¤å€¼çš„æ–¹å¼å› é¡¹ç›®è€Œå¼‚ï¼Œä½†è¿™é‡Œæœ‰å‡ ä¸ªç¤ºä¾‹ï¼š

#### CLI
```sh
babel --root-mode upward src -d lib
```

#### @babel/register
```js
require("@babel/register")({
  rootMode: "upward",
});
```

#### Webpack
```js
// webpack.config.js

module: {
  rules: [
    {
      loader: "babel-loader",
      options: {
        rootMode: "upward",
      },
    },
  ];
}
```

#### Jest

Jest é€šå¸¸å®‰è£…åœ¨å¤§ä»“çš„æ ¹ç›®å½•ï¼Œå¯èƒ½ä¸éœ€è¦é…ç½®ï¼Œä½†å¦‚æœå®ƒæ˜¯æŒ‰åŒ…å®‰è£…çš„ï¼Œé‚£ä¹ˆé…ç½®èµ·æ¥å¯èƒ½ä¼šæ›´å¤æ‚ã€‚

ä¸»è¦éƒ¨åˆ†æ˜¯åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ jest è½¬æ¢å™¨æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å« babel-jest çš„é»˜è®¤è¡Œä¸ºä»¥è®¾ç½®é€‰é¡¹ï¼Œä¾‹å¦‚

```js
// wrapper.js

module.exports = require("babel-jest").default.createTransformer({
  rootMode: "upward",
});
```

ç„¶åå°†å…¶ä¿å­˜åœ¨æŸå¤„ï¼Œç„¶åä½ å°†é€šè¿‡ [è½¬æ¢é€‰é¡¹](https://jest.nodejs.cn/docs/en/configuration#transform-object-string-string) åœ¨ä½ çš„ Jest é€‰é¡¹ä¸­ä½¿ç”¨è¯¥æ–‡ä»¶ä»£æ›¿ babel-jestï¼š

```js
// jest.config.js

"transform": {
  "^.+\\.jsx?$": "./path/to/wrapper.js"
},
```

å› æ­¤æ‰€æœ‰ JS æ–‡ä»¶éƒ½å°†ä½¿ç”¨ä½ çš„ babel-jest ç‰ˆæœ¬å¤„ç†ï¼Œå¹¶å¯ç”¨è¯¥é€‰é¡¹ã€‚

>NOTE <br>å½“ä½¿ç”¨ babel-jestï¼œæ—¶ 27ã€å¿…é¡»çœç•¥ .default éƒ¨åˆ†ï¼š require("babel-jest").createTransformer({ ...ã€‚

#### å…¶ä»–çš„

æœ‰å¾ˆå¤šå·¥å…·ï¼Œä½†å…¶æ ¸å¿ƒæ˜¯å¦‚æœå·¥ä½œç›®å½•è¿˜ä¸æ˜¯å¤§ä»“æ ¹ç›®å½•ï¼Œå®ƒä»¬éœ€è¦å¯ç”¨ rootMode é€‰é¡¹ã€‚

## åˆ†åŒ… .babelrc.json ä¸ªæ–‡ä»¶

ç±»ä¼¼äº [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶å¿…é¡»åœ¨ ["root"](https://babel.nodejs.cn/docs/options#root) ä¸­çš„æ–¹å¼ï¼Œ[.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) æ–‡ä»¶å¿…é¡»åœ¨æ ¹åŒ…ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ã€‚ è¿™æ„å‘³ç€ï¼Œä¸å·¥ä½œç›®å½•å½±å“ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) åŠ è½½çš„æ–¹å¼ç›¸åŒï¼Œå®ƒä¹Ÿä¼šå½±å“ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration)  åŠ è½½ã€‚

å‡è®¾ä½ å·²ç»æŒ‰ç…§ä¸Šé¢çš„è®¨è®ºæ­£ç¡®åŠ è½½äº† [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ï¼ŒBabel å°†åªå¤„ç†è¯¥æ ¹åŒ…ï¼ˆè€Œä¸æ˜¯å­åŒ…ï¼‰ä¸­çš„ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration)  æ–‡ä»¶ï¼Œä¾‹å¦‚

```
package.json
babel.config.js
packages/
  mod/
    package.json
    .babelrc.json
    index.js
```

ç¼–è¯‘ packages/mod/index.js æ–‡ä»¶ä¸ä¼šåŠ è½½ packages/mod/.babelrc.jsonï¼Œå› ä¸ºè¿™ä¸ª [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) åœ¨å­åŒ…ä¸­ï¼Œè€Œä¸æ˜¯æ ¹åŒ…ä¸­ã€‚

è¦å¯ç”¨è¯¥ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) çš„å¤„ç†ï¼Œä½ éœ€è¦ä½¿ç”¨ [babel.config.json](https://babel.nodejs.cn/docs/config-files#project-wide-configuration) æ–‡ä»¶ä¸­çš„ ["babelrcRoots"](https://babel.nodejs.cn/docs/options#babelrcroots) é€‰é¡¹æ¥æ‰§è¡Œ

```js
babelrcRoots: [
  ".",
  "packages/*",
],
```

è¿™æ · Babel ä¼šè®¤ä¸ºæ‰€æœ‰ packages/* åŒ…éƒ½å…è®¸åŠ è½½ [.babelrc.json](https://babel.nodejs.cn/docs/config-files#file-relative-configuration) æ–‡ä»¶ï¼Œä»¥åŠåŸå§‹ repo æ ¹ç›®å½•ã€‚

## é…ç½®å‡½æ•°æ¥å£

JS é…ç½®æ–‡ä»¶å¯èƒ½ä¼šå¯¼å‡ºå°†ä¼ é€’ç»™é…ç½®å‡½æ•° API çš„å‡½æ•°ï¼š

```js
module.exports = function(api) {
  return {};
};
```

api å¯¹è±¡å…¬å¼€äº† Babel æœ¬èº«ä»å…¶ç´¢å¼•æ¨¡å—å…¬å¼€çš„æ‰€æœ‰å†…å®¹ï¼Œä»¥åŠé…ç½®æ–‡ä»¶ç‰¹å®šçš„ APIï¼š

#### **api.version**
ç±»å‹ï¼š string

æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶çš„ Babel ç‰ˆæœ¬çš„ç‰ˆæœ¬å­—ç¬¦ä¸²ã€‚

#### **api.cache**
JS é…ç½®å¾ˆæ£’ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥å³æ—¶è®¡ç®—é…ç½®ï¼Œä½†ç¼ºç‚¹æ˜¯å®ƒä½¿ç¼“å­˜æ›´éš¾ã€‚ Babel å¸Œæœ›é¿å…åœ¨æ¯æ¬¡ç¼–è¯‘æ–‡ä»¶æ—¶é‡æ–°æ‰§è¡Œé…ç½®å‡½æ•°ï¼Œå› ä¸ºé‚£æ ·å®ƒè¿˜éœ€è¦é‡æ–°æ‰§è¡Œè¯¥é…ç½®ä¸­å¼•ç”¨çš„ä»»ä½•æ’ä»¶å’Œé¢„è®¾å‡½æ•°ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒBabel å¸Œæœ›é…ç½®å‡½æ•°çš„ç”¨æˆ·å‘Šè¯‰å®ƒå¦‚ä½•ç®¡ç†é…ç½®æ–‡ä»¶ä¸­çš„ç¼“å­˜ã€‚
- api.cache.forever() - Permacache è®¡ç®—çš„é…ç½®å¹¶ä¸”æ°¸è¿œä¸ä¼šå†æ¬¡è°ƒç”¨è¯¥å‡½æ•°ã€‚
- api.cache.never() - ä¸è¦ç¼“å­˜è¿™ä¸ªé…ç½®ï¼Œæ¯æ¬¡éƒ½é‡æ–°æ‰§è¡Œå‡½æ•°ã€‚
- api.cache.using(() => process.env.NODE_ENV) - æ ¹æ® NODE_ENV çš„å€¼è¿›è¡Œç¼“å­˜ã€‚ æ¯å½“ using å›è°ƒè¿”å›çš„å€¼ä¸é¢„æœŸå€¼ä¸åŒæ—¶ï¼Œå°†å†æ¬¡è°ƒç”¨æ•´ä½“é…ç½®å‡½æ•°ï¼Œå¹¶å°†æ–°æ¡ç›®æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚
- api.cache.invalidate(() => process.env.NODE_ENV) - æ ¹æ® NODE_ENV çš„å€¼è¿›è¡Œç¼“å­˜ã€‚ æ¯å½“ using å›è°ƒè¿”å›çš„å€¼ä¸é¢„æœŸå€¼ä¸åŒæ—¶ï¼Œå°†å†æ¬¡è°ƒç”¨æ•´ä¸ªé…ç½®å‡½æ•°ï¼Œå¹¶ä¸”ç¼“å­˜ä¸­çš„æ‰€æœ‰æ¡ç›®éƒ½å°†è¢«æ›¿æ¢ä¸ºç»“æœã€‚
- api.cache(true) - åŒ api.cache.forever()
- api.cache(false) - åŒ api.cache.never()

ç”±äºå®é™…å›è°ƒç»“æœç”¨äºæ£€æŸ¥ç¼“å­˜æ¡ç›®æ˜¯å¦æœ‰æ•ˆï¼Œå› æ­¤å»ºè®®ï¼š
- å›è°ƒåº”è¯¥å¾ˆå°å¹¶ä¸”æ²¡æœ‰å‰¯ä½œç”¨ã€‚
- å›è°ƒåº”è¯¥è¿”å›å°½å¯èƒ½å°çš„å€¼ã€‚ ä¾‹å¦‚ï¼Œä¸Šé¢çš„ .using(() => process.env.NODE_ENV) ç”¨æ³•å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºå®ƒä¼šæ ¹æ®æ£€æµ‹åˆ°çš„ NODE_ENV å€¼çš„æ•°é‡åˆ›å»ºæœªçŸ¥æ•°é‡çš„ç¼“å­˜æ¡ç›®ã€‚ åš .using(() => process.env.NODE_ENV === "development") ä¼šæ›´å®‰å…¨ï¼Œå› ä¸ºç¼“å­˜æ¡ç›®åªèƒ½æ˜¯ true æˆ– falseã€‚


#### **api.env(...)**
ç”±äº NODE_ENV æ˜¯ä¸€ç§ç›¸å½“å¸¸è§çš„åˆ‡æ¢è¡Œä¸ºæ–¹å¼ï¼Œå› æ­¤ Babel è¿˜åŒ…å«ä¸€ä¸ªä¸“é—¨ç”¨äºæ­¤çš„ API å‡½æ•°ã€‚ æ­¤ API ç”¨ä½œæ£€æŸ¥ Babel åŠ è½½çš„ ["envName"](https://babel.nodejs.cn/docs/options#envname) çš„å¿«é€Ÿæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å…¶ä»–è¦†ç›–ç¯å¢ƒï¼Œåˆ™å°† NODE_ENV è€ƒè™‘åœ¨å†…ã€‚

å®ƒæœ‰å‡ ç§ä¸åŒçš„å½¢å¼ï¼š
- å¦‚æœ envName === "production"ï¼Œapi.env("production") è¿”å› trueã€‚
- å¦‚æœ ["development", "test"].includes(envName)ï¼Œapi.env(["development", "test"]) è¿”å› trueã€‚
- api.env() è¿”å›å½“å‰çš„ envName å­—ç¬¦ä¸²ã€‚
- å¦‚æœ env ä»¥ "test-" å¼€å¤´ï¼Œåˆ™ api.env(envName => envName.startsWith("test-")) è¿”å› trueã€‚

>NOTE <br>è¯¥å‡½æ•°åœ¨å†…éƒ¨åˆ©ç”¨ä¸Šé¢æåˆ°çš„ api.cache æ¥ç¡®ä¿ Babel çŸ¥é“è¯¥æ„å»ºä¾èµ–äºç‰¹å®šçš„ envNameã€‚ ä½ ä¸åº”å°†å…¶ä¸ api.cache.forever() æˆ– api.cache.never() ä¸€èµ·ä½¿ç”¨ã€‚

#### **api.caller(cb)**
æ­¤ API ç”¨ä½œè®¿é—®å·²ä¼ é€’ç»™ Babel çš„ caller æ•°æ®çš„ä¸€ç§æ–¹å¼ã€‚ ç”±äºè®¸å¤š Babel å®ä¾‹å¯èƒ½è¿è¡Œåœ¨å…·æœ‰ä¸åŒ caller å€¼çš„åŒä¸€è¿›ç¨‹ä¸­ï¼Œå› æ­¤æ­¤ API æ—¨åœ¨è‡ªåŠ¨é…ç½® api.cacheï¼Œä¸ api.env() ç›¸åŒã€‚

caller å€¼å¯ç”¨ä½œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ å®ƒæœ€å¥½ä¸ç±»ä¼¼çš„ä¸œè¥¿ä¸€èµ·ä½¿ç”¨

```js
function isBabelRegister(caller) {
  return !!(caller && caller.name === "@babel/register");
}

module.exports = function(api) {
  const isRegister = api.caller(isBabelRegister);

  return {
    // ...
  };
};
```

æ ¹æ®ç‰¹å®šç¯å¢ƒåˆ‡æ¢é…ç½®è¡Œä¸ºã€‚

#### **api.assertVersion(range)**
è™½ç„¶ api.version é€šå¸¸å¾ˆæœ‰ç”¨ï¼Œä½†æœ‰æ—¶åªå£°æ˜ä½ çš„ç‰ˆæœ¬ä¼šå¾ˆå¥½ã€‚ è¿™ä¸ª API æä¾›äº†ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š
```js
module.exports = function(api) {
  api.assertVersion("^7.2");

  return {
    // ...
  };
};
```
